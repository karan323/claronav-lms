<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Claronav LMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
        }
        .admin-header h1 {
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        .nav-tabs .nav-link {
            border: none;
            border-radius: 0;
            color: #495057;
            font-weight: 500;
            font-size: 1.1rem;
        }
        .nav-tabs .nav-link.active {
            background-color: #667eea;
            color: white;
        }
        .table-responsive {
            margin-top: 2rem;
        }
        .table thead {
            background-color: #667eea;
            color: white;
        }
        .upload-zone {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background-color: #f0f4ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-zone:hover {
            background-color: #e8ecff;
            border-color: #764ba2;
        }
        .upload-zone.dragover {
            background-color: #e8ecff;
            border-color: #764ba2;
        }
        .module-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .module-card h5 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .content-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }
        .content-item:last-child {
            border-bottom: none;
        }
        .btn-custom {
            border-radius: 5px;
            font-weight: 500;
        }
        .alert-info {
            background-color: #e8ecff;
            border-color: #667eea;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="container d-flex align-items-center justify-content-between">
            <div>
                <h1><i class="fa-solid fa-shield"></i> Admin Panel</h1>
                <p class="lead mb-0">Claronav LMS Management</p>
            </div>
            <button id="logoutBtn" class="btn btn-light">Logout</button>
        </div>
    </div>

    <div class="container mt-5">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                    <i class="fa-solid fa-users"></i> Users & Progress
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="content-tab" data-bs-toggle="tab" data-bs-target="#content" type="button" role="tab">
                    <i class="fa-solid fa-file-upload"></i> Module Content
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="adminTabContent">
            <!-- Tab 1: Users & Progress -->
            <div class="tab-pane fade show active" id="users" role="tabpanel">
                <h3 class="mb-4">Users & Progress Report</h3>
                <div id="usersLoading" class="alert alert-info">
                    <i class="fa-solid fa-spinner fa-spin"></i> Loading users...
                </div>
                <div id="usersError" class="alert alert-danger" style="display:none;"></div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="usersTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Hospital</th>
                                <th>Serial Number</th>
                                <th>Cranial %</th>
                                <th>Spine %</th>
                                <th>ENT %</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: Module Content -->
            <div class="tab-pane fade" id="content" role="tabpanel">
                <h3 class="mb-4">Module Content Management</h3>
                <div id="contentError" class="alert alert-danger" style="display:none;"></div>
                
                <!-- Upload Form -->
                <div class="card mb-5">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fa-solid fa-cloud-arrow-up"></i> Upload Content</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="moduleSelect" class="form-label">Select Module:</label>
                                    <select class="form-select" id="moduleSelect" required>
                                        <option value="">-- Choose Module --</option>
                                        <option value="cranial">Cranial Navigation</option>
                                        <option value="spine">Spine Navigation</option>
                                        <option value="ent">ENT Navigation</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="contentType" class="form-label">Content Type:</label>
                                    <select class="form-select" id="contentType" required>
                                        <option value="">-- Choose Type --</option>
                                        <option value="pdf">PDF</option>
                                        <option value="ppt">PowerPoint (PPT)</option>
                                        <option value="video">Video</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="contentTitle" class="form-label">Content Title:</label>
                                <input type="text" class="form-control" id="contentTitle" placeholder="e.g., Introduction to Cranial Navigation" required>
                            </div>
                            <div class="mb-3">
                                <label for="contentFile" class="form-label">Upload File:</label>
                                <div class="upload-zone" id="uploadZone">
                                    <i class="fa-solid fa-file-arrow-up fa-3x mb-3" style="color: #667eea;"></i>
                                    <p class="mb-2"><strong>Drag & drop your file here</strong></p>
                                    <p class="text-muted small">or click to browse</p>
                                    <input type="file" id="contentFile" class="form-control" style="display:none;" required>
                                </div>
                            </div>
                            <div class="mb-3" id="fileNameDisplay" style="display:none;">
                                <small class="text-success"><i class="fa-solid fa-check-circle"></i> File selected: <span id="selectedFileName"></span></small>
                            </div>
                            <button type="submit" class="btn btn-primary btn-custom">
                                <i class="fa-solid fa-upload"></i> Upload Content
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Content List by Module -->
                <h5 class="mt-5 mb-3">Current Module Content</h5>
                <div id="contentLoading" class="alert alert-info">
                    <i class="fa-solid fa-spinner fa-spin"></i> Loading module content...
                </div>
                <div id="moduleContents"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = localStorage.getItem('API_BASE') || 'https://claronav-lms.onrender.com';
        const adminToken = localStorage.getItem('adminToken');

        // Redirect to login if not authenticated
        if (!adminToken) {
            window.location.href = 'admin-login.html';
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = 'admin-login.html';
        });

        // Load users and progress
        async function loadUsers() {
            try {
                const response = await fetch(API_BASE + '/api/admin/users?token=' + encodeURIComponent(adminToken));
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error || 'Failed to fetch users');
                
                document.getElementById('usersLoading').style.display = 'none';
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = '';
                
                data.users.forEach(user => {
                    const row = document.createElement('tr');
                    const progress = data.progress[user.email] || {};
                    row.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.firstName}</td>
                        <td>${user.lastName}</td>
                        <td>${user.hospital || '-'}</td>
                        <td>${user.serial || '-'}</td>
                        <td><span class="badge bg-primary">${progress.cranial || 0}%</span></td>
                        <td><span class="badge bg-success">${progress.spine || 0}%</span></td>
                        <td><span class="badge bg-warning">${progress.ent || 0}%</span></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                document.getElementById('usersLoading').style.display = 'none';
                document.getElementById('usersError').textContent = 'Error: ' + err.message;
                document.getElementById('usersError').style.display = 'block';
            }
        }

        // Load module content
        async function loadModuleContent() {
            try {
                const response = await fetch(API_BASE + '/api/admin/modules/content?token=' + encodeURIComponent(adminToken));
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error || 'Failed to fetch content');
                
                document.getElementById('contentLoading').style.display = 'none';
                const container = document.getElementById('moduleContents');
                container.innerHTML = '';
                
                ['cranial', 'spine', 'ent'].forEach(module => {
                    const moduleData = data.content[module] || [];
                    const card = document.createElement('div');
                    card.className = 'module-card';
                    
                    const moduleName = module.charAt(0).toUpperCase() + module.slice(1) + ' Navigation';
                    card.innerHTML = `<h5>${moduleName}</h5>`;
                    
                    if (moduleData.length === 0) {
                        card.innerHTML += '<p class="text-muted">No content uploaded yet.</p>';
                    } else {
                        moduleData.forEach((content, idx) => {
                            const typeIcon = content.type === 'pdf' ? 'fa-file-pdf' : 
                                           content.type === 'ppt' ? 'fa-file-powerpoint' : 
                                           'fa-video';
                            const typeColor = content.type === 'pdf' ? '#dc3545' : 
                                            content.type === 'ppt' ? '#ff9800' : 
                                            '#4CAF50';
                            
                            card.innerHTML += `
                                <div class="content-item">
                                    <div>
                                        <i class="fa-solid ${typeIcon}" style="color:${typeColor}; margin-right:0.5rem;"></i>
                                        <strong>${content.title}</strong>
                                        <small class="text-muted ms-2">(${content.type.toUpperCase()})</small>
                                    </div>
                                    <button class="btn btn-sm btn-danger" onclick="deleteContent('${module}', ${idx})">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        });
                    }
                    
                    container.appendChild(card);
                });
            } catch (err) {
                document.getElementById('contentLoading').style.display = 'none';
                document.getElementById('contentError').textContent = 'Error: ' + err.message;
                document.getElementById('contentError').style.display = 'block';
            }
        }

        // File upload and drag-drop
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('contentFile');
        
        uploadZone.addEventListener('click', () => fileInput.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                updateFileDisplay();
            }
        });
        
        fileInput.addEventListener('change', updateFileDisplay);
        
        function updateFileDisplay() {
            if (fileInput.files.length > 0) {
                document.getElementById('fileNameDisplay').style.display = 'block';
                document.getElementById('selectedFileName').textContent = fileInput.files[0].name;
            } else {
                document.getElementById('fileNameDisplay').style.display = 'none';
            }
        }

        // Upload form submission
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const module = document.getElementById('moduleSelect').value;
            const type = document.getElementById('contentType').value;
            const title = document.getElementById('contentTitle').value;
            const file = document.getElementById('contentFile').files[0];
            
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            const formData = new FormData();
            formData.append('module', module);
            formData.append('type', type);
            formData.append('title', title);
            formData.append('file', file);
            formData.append('token', adminToken);
            
            try {
                const response = await fetch(API_BASE + '/api/admin/modules/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Upload failed');
                
                alert('Content uploaded successfully!');
                document.getElementById('uploadForm').reset();
                document.getElementById('fileNameDisplay').style.display = 'none';
                loadModuleContent();
            } catch (err) {
                alert('Error uploading content: ' + err.message);
            }
        });

        // Delete content
        async function deleteContent(module, idx) {
            if (!confirm('Are you sure you want to delete this content?')) return;
            
            try {
                const response = await fetch(API_BASE + '/api/admin/modules/content', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ module, index: idx, token: adminToken })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Delete failed');
                
                loadModuleContent();
            } catch (err) {
                alert('Error deleting content: ' + err.message);
            }
        }

        // Initialize
        loadUsers();
        loadModuleContent();

        // Bootstrap tab fallback
        try {
            if (typeof bootstrap === 'undefined' || !bootstrap.Tab) {
                document.querySelectorAll('#adminTabs button').forEach(btn => {
                    btn.addEventListener('click', function (e) {
                        e.preventDefault();
                        const targetSelector = this.getAttribute('data-bs-target') || this.dataset.bsTarget;
                        const target = document.querySelector(targetSelector);
                        if (!target) return;
                        
                        document.querySelectorAll('#adminTabs .nav-link').forEach(n => n.classList.remove('active'));
                        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show','active'));
                        
                        this.classList.add('active');
                        target.classList.add('show','active');
                    });
                });
            }
        } catch (e) {
            console.error('Tab fallback error', e);
        }
    </script>
</body>
</html>
